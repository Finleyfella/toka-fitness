 Validation Functions - input validation and sanitization
def validate_email_format(email):
    """Validate email format using regular expressions"""
    if not email or email.strip() == "":
        return False, "Email cannot be empty"  # Check for empty email
    
    # Regular expression pattern for valid email format
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    if not re.match(pattern, email):
        return False, "Invalid email format"  # Email doesn't match pattern
    
    return True, "Valid email"  # Email is valid

def validate_password(password):
    """Validate password strength - must meet security requirements"""
    if len(password) < 8:
        return False, "Password must be at least 8 characters"  # Minimum length
    if not re.search(r"[A-Z]", password):
        return False, "Password must contain at least one uppercase letter"  # Uppercase check
    if not re.search(r"[a-z]", password):
        return False, "Password must contain at least one lowercase letter"  # Lowercase check
    if not re.search(r"\d", password):
        return False, "Password must contain at least one number"  # Number check
    if not re.search(r"[!@#$%^&*(),.?\":{}|<>]", password):
        return False, "Password must contain at least one special character"  # Special character check
    return True, "Valid password"  # Password meets all requirements

# Authentication Functions - handle user login and account creation
def login_user():
    """Handle user login process - validate credentials and set session"""
    global user_LoggedIn, current_user_id  # Access global session variables
    email = login_email.value.strip()  # Get email from login form
    password = login_pw.value  # Get password from login form

    # Basic validation - check fields aren't empty
    if not email or not password:
        AppErrors.value = "Please fill in all fields"
        return

    # Validate email format
    is_valid, error_msg = validate_email_format(email)
    if not is_valid:
        AppErrors.value = error_msg
        return

    # Query database for user with this email
    users = query_database("SELECT userID, U_PW, U_Premium FROM User WHERE U_Email = ?", (email,))
    
    # Check if user exists
    if not users:
        AppErrors.value = "Invalid email or password"
        return

    # Extract user data from query result
    user_id, stored_hash, premium = users[0]
    
    try:
        # Verify password against stored hash using bcrypt
        if bcrypt.checkpw(password.encode('utf-8'), stored_hash.encode('utf-8')):
            # Login successful - set global session variables
            user_LoggedIn = email
            current_user_id = user_id
            
            # Check if user has agreed to cookies (GDPR compliance)
            cookie_agreed = query_database("SELECT U_CookieAgreement FROM User WHERE userID = ?", (user_id,))[0][0]
            if not cookie_agreed:
                show_cookie_agreement()  # Show cookie agreement if not agreed
            else:
                show_dashboard(premium)  # Show appropriate dashboard based on premium status
        else:
            AppErrors.value = "Invalid email or password"  # Password doesn't match
    except Exception as e:
        AppErrors.value = "Login error. Please try again."  # General error handling

def create_account():
    """Handle new user account creation - validate input and create account"""
    email = sign_txtbox6.value.strip()  # Get email from signup form
    password = sign_txtbox2.value  # Get password from signup form
    confirm_password = sign_txtbox3.value  # Get password confirmation
    firstname = sign_txtbox4.value.strip()  # Get first name
    surname = sign_txtbox5.value.strip()  # Get surname

    # Validation - check all required fields are filled
    if not all([email, password, confirm_password, firstname, surname]):
        SignErrors.value = "All fields are required"
        return

    # Validate name lengths
    if len(firstname) < 2 or len(firstname) > 20:
        SignErrors.value = "First name must be 2-20 characters"
        return

    if len(surname) < 2 or len(surname) > 20:
        SignErrors.value = "Surname must be 2-20 characters"
        return

    # Validate email format
    is_valid, error_msg = validate_email_format(email)
    if not is_valid:
        SignErrors.value = error_msg
        return

    # Validate password strength
    is_valid, error_msg = validate_password(password)
    if not is_valid:
        SignErrors.value = error_msg
        return

    # Check passwords match
    if password != confirm_password:
        SignErrors.value = "Passwords do not match"
        return

    # Check if email already exists in database
    if query_database("SELECT userID FROM User WHERE U_Email = ?", (email,)):
        SignErrors.value = "Email already registered"
        return

    # All validation passed - create account with hashed password
    hashed_pw = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
    execute_sql(
        "INSERT INTO User (U_Email, U_PW, U_FirstName, U_SecondName) VALUES (?, ?, ?, ?)",
        (email, hashed_pw.decode('utf-8'), firstname, surname)
    )
    
    info("Success", "Account created successfully!")  # Success notification
    BackToLogin()  # Return to login screen
